name: CI/CD Pipeline

on:
  push:
    branches: [main, release, development]

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  trivy-filesystem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner in filesystem mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      event-service: ${{ steps.changes.outputs.event-service }}
      booking-service: ${{ steps.changes.outputs.booking-service }}
      mock-payment-service: ${{ steps.changes.outputs.mock-payment-service }}
      gateway: ${{ steps.changes.outputs.gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            event-service:
              - 'EventService/**'
            booking-service:
              - 'BookingService/**'
            mock-payment-service:
              - 'MockPaymentService/**'
            gateway:
              - 'Gateway/**'
            user-service:
              - 'UserService/**'
            frontend:
              - 'Frontend/**'

  build-services:
    needs: detect-changes
    strategy:
      fail-fast: false
      matrix:
        include:
          - service-name: EventService
            service-path: EventService
            change-check: event-service
            has-prisma: true
            has-dockerfile: true
            image-name: event
          - service-name: BookingService
            service-path: BookingService
            change-check: booking-service
            has-prisma: true
            has-dockerfile: true
            image-name: booking
          - service-name: MockPaymentService
            service-path: MockPaymentService
            change-check: mock-payment-service
            has-prisma: false
            has-dockerfile: true
            image-name: payment
          - service-name: Gateway
            service-path: Gateway
            change-check: gateway
            has-prisma: false
            has-dockerfile: false
            image-name: gateway
          - service-name: UserService
            service-path: UserService
            change-check: user-service
            has-prisma: true
            has-dockerfile: false
            image-name: user
          - service-name: Frontend
            service-path: Frontend
            change-check: frontend
            has-prisma: false
            has-dockerfile: true
            image-name: frontend
    if: |
      (matrix.change-check == 'event-service' && needs.detect-changes.outputs.event-service == 'true') ||
      (matrix.change-check == 'booking-service' && needs.detect-changes.outputs.booking-service == 'true') ||
      (matrix.change-check == 'mock-payment-service' && needs.detect-changes.outputs.mock-payment-service == 'true') ||
      (matrix.change-check == 'gateway' && needs.detect-changes.outputs.gateway == 'true') ||
      (matrix.change-check == 'user-service' && needs.detect-changes.outputs.user-service == 'true') ||
      (matrix.change-check == 'frontend' && needs.detect-changes.outputs.frontend == 'true')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: ${{ matrix.service-name }}
      service-path: ${{ matrix.service-path }}
      has-prisma: ${{ matrix.has-prisma }}
      has-dockerfile: ${{ matrix.has-dockerfile }}
      image-name: ${{ matrix.image-name }}
    secrets: inherit

  trivy-container:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image-name: [event, booking, payment, frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Set image prefix
        run: |
          echo "IMAGE_PREFIX=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/ticketing" >> $GITHUB_ENV
      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run Trivy vulnerability scanner in container mode
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ env.IMAGE_PREFIX }}-${{ matrix.image-name }}:latest
          format: 'sarif'
          output: 'trivy-container-${{ matrix.image-name }}.sarif'
          severity: 'CRITICAL,HIGH'
      - name: Upload Trivy container results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-container-${{ matrix.image-name }}.sarif'

  deploy:
    needs: [detect-changes, build-services]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release' || github.ref == 'refs/heads/development'
    uses: ./.github/workflows/deploy.yml
    with:
      event-service-changed: ${{ needs.detect-changes.outputs.event-service == 'true' }}
      booking-service-changed: ${{ needs.detect-changes.outputs.booking-service == 'true' }}
      payment-service-changed: ${{ needs.detect-changes.outputs.mock-payment-service == 'true' }}
      frontend-changed: ${{ needs.detect-changes.outputs.frontend == 'true' }}
      gateway-changed: ${{ needs.detect-changes.outputs.gateway == 'true' }}
      user-service-changed: ${{ needs.detect-changes.outputs.user-service == 'true' }}
      image-tag: ${{ github.sha }}
    secrets: inherit
