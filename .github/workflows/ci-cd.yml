name: CI/CD Pipeline

on:
  push:
    branches: [main, release, development]

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  trivy-filesystem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner in filesystem mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      event-service: ${{ steps.changes.outputs.event-service }}
      booking-service: ${{ steps.changes.outputs.booking-service }}
      mock-payment-service: ${{ steps.changes.outputs.mock-payment-service }}
      gateway: ${{ steps.changes.outputs.gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug - Show changed files
        run: |
          echo "=== Changed files in this push ==="
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            echo "Comparing: ${{ github.event.before }}..${{ github.sha }}"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "Could not compare commits"
          else
            echo "Comparing: HEAD~1..HEAD"
            git diff --name-only HEAD~1 HEAD || echo "No previous commit to compare"
          fi
          echo ""
          echo "=== Current branch ==="
          echo "${{ github.ref }}"
          echo "=== Commit SHA ==="
          echo "${{ github.sha }}"
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          base: ${{ github.event.before }}
          filters: |
            event-service:
              - 'EventService/**'
            booking-service:
              - 'BookingService/**'
            mock-payment-service:
              - 'MockPaymentService/**'
            gateway:
              - 'Gateway/**'
            user-service:
              - 'UserService/**'
            frontend:
              - 'Frontend/**'
      
      - name: Debug - Show change detection results
        run: |
          echo "=== Change Detection Results ==="
          echo "event-service: ${{ steps.changes.outputs.event-service }}"
          echo "booking-service: ${{ steps.changes.outputs.booking-service }}"
          echo "mock-payment-service: ${{ steps.changes.outputs.mock-payment-service }}"
          echo "gateway: ${{ steps.changes.outputs.gateway }}"
          echo "user-service: ${{ steps.changes.outputs.user-service }}"
          echo "frontend: ${{ steps.changes.outputs.frontend }}"

  build-event:
    needs: detect-changes
    if: needs.detect-changes.outputs.event-service == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: EventService
      service-path: EventService
      has-prisma: true
      has-dockerfile: true
      image-name: event
    secrets: inherit

  build-booking:
    needs: detect-changes
    if: needs.detect-changes.outputs.booking-service == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: BookingService
      service-path: BookingService
      has-prisma: true
      has-dockerfile: true
      image-name: booking
    secrets: inherit

  build-payment:
    needs: detect-changes
    if: needs.detect-changes.outputs.mock-payment-service == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: MockPaymentService
      service-path: MockPaymentService
      has-prisma: false
      has-dockerfile: true
      image-name: payment
    secrets: inherit

  build-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: Gateway
      service-path: Gateway
      has-prisma: false
      has-dockerfile: false
      image-name: gateway
    secrets: inherit

  build-user:
    needs: detect-changes
    if: needs.detect-changes.outputs.user-service == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: UserService
      service-path: UserService
      has-prisma: true
      has-dockerfile: false
      image-name: user
    secrets: inherit

  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: Frontend
      service-path: Frontend
      has-prisma: false
      has-dockerfile: true
      image-name: frontend
    secrets: inherit

  trivy-container:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image-name: [event, booking, payment, frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Set image prefix
        run: |
          echo "IMAGE_PREFIX=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/ticketing" >> $GITHUB_ENV
      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run Trivy vulnerability scanner in container mode
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ env.IMAGE_PREFIX }}-${{ matrix.image-name }}:latest
          format: 'sarif'
          output: 'trivy-container-${{ matrix.image-name }}.sarif'
          severity: 'CRITICAL,HIGH'
      - name: Upload Trivy container results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-container-${{ matrix.image-name }}.sarif'

  deploy:
    needs: [detect-changes, build-event, build-booking, build-payment, build-gateway, build-user, build-frontend]
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release' || github.ref == 'refs/heads/development') &&
      (needs.build-event.result != 'failure') &&
      (needs.build-booking.result != 'failure') &&
      (needs.build-payment.result != 'failure') &&
      (needs.build-gateway.result != 'failure') &&
      (needs.build-user.result != 'failure') &&
      (needs.build-frontend.result != 'failure')
    uses: ./.github/workflows/deploy.yml
    with:
      event-service-changed: ${{ needs.detect-changes.outputs.event-service == 'true' }}
      booking-service-changed: ${{ needs.detect-changes.outputs.booking-service == 'true' }}
      payment-service-changed: ${{ needs.detect-changes.outputs.mock-payment-service == 'true' }}
      frontend-changed: ${{ needs.detect-changes.outputs.frontend == 'true' }}
      gateway-changed: ${{ needs.detect-changes.outputs.gateway == 'true' }}
      user-service-changed: ${{ needs.detect-changes.outputs.user-service == 'true' }}
      image-tag: ${{ github.sha }}
    secrets: inherit
